--Users table
create table users (
user_name character varying(30) not null,
pass_word character varying(30) not null,
first_name character varying(30) not null,
last_name character varying(30) not null,
date_join date,
date_birth date,
province character varying(30) not null,
district character varying(30) not null,
email character varying(30) ,
phone character varying(30),
is_superuser bool,
is_staff bool,
CONSTRAINT users_pk PRIMARY KEY (user_name)
);

--Coupon table
create table coupon(
coupon_id character varying(10) NOT NULL,
code character varying(10) not null,
date_exp date not null,
amount real not null,
CONSTRAINT coupon_pk PRIMARY KEY (coupon_id)
);

--Items table
create table items(
item_id character varying(10)  not null,
item_name character varying(20) not null,
theme character varying(20) not null,
price integer not null,
quantity integer not null,
brand character varying(20),
sold integer,
img character varying(30),
CONSTRAINT item_pk PRIMARY KEY (item_id)
);

--Bill table
create table bill(
bill_id character varying(10) not null,
user_name character varying(30) not null,
coupon_id character varying(10) ,
bill_date date not null,
total_due integer,
CONSTRAINT bill_pk PRIMARY KEY (bill_id)
);

--Orderlines table
CREATE TABLE orderlines (
    orderlines_id int GENERATED BY DEFAULT AS IDENTITY ,
    bill_id character varying(10) NOT NULL,
    item_id character varying(10) NOT NULL,
    amount integer Not null,
    CONSTRAINT orderlines_pk PRIMARY KEY (orderlines_id)
);
-- Cart table
CREATE TABLE cart (
    user_name character varying(30) not null,
    item_id character varying(10) NOT NULL,
    amount integer Not null
);

--Add foreignkey
ALTER TABLE ONLY bill
    ADD CONSTRAINT fk_billid_username FOREIGN KEY (user_name) REFERENCES users(user_name) ON DELETE CASCADE;

ALTER TABLE ONLY bill
    ADD CONSTRAINT fk_billid_couponid FOREIGN KEY (coupon_id) REFERENCES coupon(coupon_id) ON DELETE CASCADE;
	

ALTER TABLE ONLY orderlines
    ADD CONSTRAINT fk_orderlinesid_billid FOREIGN KEY (bill_id) REFERENCES bill(bill_id) ON DELETE CASCADE;
ALTER TABLE ONLY orderlines
    ADD CONSTRAINT fk_orderlinesid_itemid FOREIGN KEY (item_id) REFERENCES items(item_id) ON DELETE CASCADE;
    ALTER TABLE ONLY cart
	ADD CONSTRAINT fk_cart_itemid FOREIGN KEY (item_id) REFERENCES items(item_id) ON DELETE CASCADE;
    ALTER TABLE ONLY cart
	 ADD CONSTRAINT fk_cart_username FOREIGN KEY (user_name) REFERENCES users(user_name) ON DELETE CASCADE;	
    
 -- Insert data
 --1. Users
 
insert into users(pass_word,user_name,first_name,last_name,date_join,date_birth,province,district,email,phone,is_superuser,is_staff) values( '142020','thao_tran', 'Nguyên', 'Trần Thảo', '2019-12-24','2000-12-2', 'Hà Nam', 'Phủ Lý' ,'nguyen_tt@gmail.com','0818324098', false, true );
insert into users(pass_word,user_name,first_name,last_name,date_join,date_birth,province,district,email,phone,is_superuser,is_staff) values('242020','hoa_nguyen', 'Hoa', 'Nguyễn Thanh', '2019-11-2',  '1999-12-12', 'Bắc Ninh', 'GIa Bình' ,'hoa_nt@gmail.com','0918390545', true, false );
insert into users(pass_word,user_name,first_name,last_name,date_join,date_birth,province,district,email,phone,is_superuser,is_staff) values('222020','quan_th', 'Quân', 'Tạ Hải', '1989-5-20', '2020-12-10', 'Hà Nội', 'Hai Bà Trưng','quan_th@gmail.com','0765324645', true, false );
insert into users(pass_word,user_name,first_name,last_name,date_join,date_birth,province,district,email,phone,is_superuser,is_staff) values( '112019','trang_nguyen', 'Trang', 'Nguyễn Phương', '2020-1-10', '2002-12-5', 'Hà Nội', 'Hoàn Kiếm','trang_np@gmail.com','0819324645', true, false);
insert into users(pass_word,user_name,first_name,last_name,date_join,date_birth,province,district,email,phone,is_superuser,is_staff) values('322019','thaolevi', 'Thảo', 'Lê Vi', '2019-8-24',  '2000-12-8', 'Hưng Yên', 'Phủ Lý','thao_levi@gmail.com','0874324645', true, false );
insert into users(pass_word,user_name,first_name,last_name,date_join,date_birth,province,district,email,phone,is_superuser,is_staff) values( '342019','anleminh', 'An', 'Lê Minh', '2019-10-24', '1998-12-6', 'Hưng Yên', 'Phù Cừ' ,'an.lm@gmail.com','0458324645', true, false );
insert into users(pass_word,user_name,first_name,last_name,date_join,date_birth,province,district,email,phone,is_superuser,is_staff) values( '152020','minhanh', 'Anh', 'Trần Minh', '2020-10-05', '2000-12-1', 'Hà Nội', 'Đống Đa' ,'anh.tm@gmail.com','0918329875', false, true );


--2. Items
insert into items (item_id, item_name, theme, price, quantity, brand) values('001', 'Áo hoodie ', 'Áo', 350000,5,'H&M');
insert into items (item_id, item_name, theme, price, quantity, brand) values ('002', 'Áo len lông thỏ ', 'Áo', 200000, 10, 'Mango' );
insert into items (item_id, item_name, theme, price, quantity, brand) values ('003', 'Áo len có cổ ', 'Áo', 540000, 7, 'Mango' );  
insert into items (item_id, item_name, theme, price, quantity, brand) values ('004', 'Quần Jockers', 'Quần ', 600000, 30, 'uniqlo');
insert into items (item_id, item_name, theme, price, quantity, brand) values ('005', 'Áo phông', 'Áo', 300000, 18, 'Zara');
insert into items (item_id, item_name, theme, price, quantity, brand) values ('006', 'Chân váy chữ A', 'Váy', 250000, 19, 'Zara');
insert into items (item_id, item_name, theme, price, quantity, brand) values ('007', 'Áo dạ', 'Áo', 500000, 9, 'Emily');
insert into items (item_id, item_name, theme, price, quantity, brand) values ('008', 'Áo cadigan', 'Áo', 230000, 5, 'Emily');
insert into items (item_id, item_name, theme, price, quantity, brand) values ('009', 'Áo khoác gió', 'Áo', 380000, 9, 'Emily');
insert into items (item_id, item_name, theme, price, quantity, brand) values ('010', 'Áo giữ nhiệt', 'Áo', 360000, 9, 'uniqlo');
insert into items (item_id, item_name, theme, price, quantity, brand) values ('011', 'Áo gile', 'Áo', 250000, 3, 'H&M');
insert into items (item_id, item_name, theme, price, quantity, brand) values ('012', 'Quần Baggy ','Quần', 450000, 30, 'uniqlo');
insert into items (item_id, item_name, theme, price, quantity, brand) values ('013', 'Khăn len','Khăn', 250000,25,'Zara');
-- Coupon
insert into coupon values('23001', '11-11', '2020-11-30', 0.2);
insert into coupon values('23002', '12-12', '2020-12-31', 0.6);
insert into coupon values('23003', 'TET_30%', '2021-1-31', 0.3);
insert into coupon values('23004', 'NOEL_60%', '2020-12-20', 0.6);
insert into coupon values('23005', 'LE_HOI_40%', '2021-12-28', 0.4);
--Bill
insert into bill(bill_id, user_name, coupon_id, bill_date) values ('13001', 'minhanh' , '23002','2020-4-12');
insert into bill(bill_id, user_name, coupon_id, bill_date) values ('13004', 'minhanh', '23001','2020-8-12');
insert into bill(bill_id, user_name, coupon_id, bill_date) values ('13005', 'quan_th', '23002','2020-4-12');
insert into bill(bill_id, user_name, coupon_id, bill_date) values ('13006', 'thao_tran', '23001','2020-11-12');
insert into bill(bill_id, user_name, coupon_id, bill_date) values ('13007', 'thao_tran', '23004','2020-9-12');
insert into bill(bill_id, user_name, coupon_id, bill_date) values ('13008', 'hoa_nguyen', '23002','2020-12-24');
insert into bill(bill_id, user_name, coupon_id, bill_date) values ('13009', 'minhanh', '23001','2020-10-30');
insert into bill(bill_id, user_name, coupon_id, bill_date) values ('13010', 'thaolevi', '23001','2020-6-1');
insert into bill(bill_id, user_name, coupon_id, bill_date) values ('13011', 'quan_th', '23003','2020-12-23');


--Orderlines
insert into orderlines(bill_id,item_id,amount) values('13001', '010', 1);
insert into orderlines(bill_id,item_id,amount) values('13001', '001', 1);
insert into orderlines(bill_id,item_id,amount) values( '13001', '002', 1);
insert into orderlines(bill_id,item_id,amount) values('13001', '011', 1);

insert into orderlines(bill_id,item_id,amount) values('13011', '003', 1);
insert into orderlines(bill_id,item_id,amount) values( '13011', '004', 1);

insert into orderlines(bill_id,item_id,amount) values('13004', '011', 1);
insert into orderlines(bill_id,item_id,amount) values('13004', '003', 1);
insert into orderlines(bill_id,item_id,amount) values('13005', '002', 1);

insert into orderlines(bill_id,item_id,amount) values('13004', '004', 1);
insert into orderlines(bill_id,item_id,amount) values('13004', '002', 1);

insert into orderlines(bill_id,item_id,amount) values('13005', '005', 1);

insert into orderlines(bill_id,item_id,amount) values('13006', '005', 1);
insert into orderlines(bill_id,item_id,amount) values('13006', '006', 1);

insert into orderlines(bill_id,item_id,amount) values('13007', '006', 1);
insert into orderlines(bill_id,item_id,amount) values( '13007', '007', 1);
insert into orderlines(bill_id,item_id,amount) values( '13007', '008', 1);

insert into orderlines(bill_id,item_id,amount) values('13008', '009', 1);
insert into orderlines(bill_id,item_id,amount) values('13008', '010', 2);

insert into orderlines(bill_id,item_id,amount) values('13009', '001', 1);
insert into orderlines(bill_id,item_id,amount) values('13009', '001', 1);
insert into orderlines(bill_id,item_id,amount) values( '13009', '003', 1);
insert into orderlines(bill_id,item_id,amount) values('13009', '004', 1);
insert into orderlines(bill_id,item_id,amount) values( '13009', '005', 1);
insert into orderlines(bill_id,item_id,amount) values('13009', '006', 1);

insert into orderlines(bill_id,item_id,amount) values('13010', '007', 1);
insert into orderlines(bill_id,item_id,amount) values('13010', '008', 1);
insert into orderlines(bill_id,item_id,amount) values('13010', '009', 1);

insert into orderlines(bill_id,item_id,amount) values( '13011', '010', 1);
insert into orderlines(bill_id,item_id,amount) values('13011', '011', 1);
insert into orderlines(bill_id,item_id,amount) values('13011', '001', 1);
insert into orderlines(bill_id,item_id,amount) values('13011', '002', 1);

--Total_due function
create or replace function total_due(in bill__id character, out total integer)  as
$$
begin
  select sum(price*amount) into total from items,orderlines where items.item_id = orderlines.item_id and orderlines.bill_id = bill__id ;
end;
$$  
stable
security definer
language plpgsql;
update bill set  total_due= total_due(bill_id)





























